<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Keranjang Belanja</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"/>
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .cart-container { max-width: 800px; margin: 2rem auto; }
    .cart-item { background: white; border-radius: 10px; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .btn-delete { background: #dc3545; color: white; }
    .btn-delete:hover { background: #c82333; }
    .btn-checkout { background: #0d6efd; color: white; font-weight: bold; }
    .btn-checkout:hover { background: #0b5ed7; }
    .empty-cart { text-align: center; color: #6c757d; padding: 3rem; }
  </style>
</head>
<body>

  <div class="cart-container">
    <h2 class="text-center mb-4">
      Keranjang Belanja
    </h2>

    <div id="cartItems"></div>

    <div class="text-end mt-3">
      <h4>Total: <span id="totalPrice" class="text-danger">Rp0</span></h4>
    </div>

    <div class="text-center mt-4">
      <a href="checkout.html" id="checkoutBtn" class="btn btn-checkout btn-lg px-5" style="display: none;">
        LANJUT KE CHECKOUT
      </a>
      <p id="emptyMessage" class="empty-cart">Keranjang belanja kosong.</p>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost/Semester%203/Toko%20premium%20store/api_store/api_storeapi';

    const cartItemsDiv = document.getElementById('cartItems');
    const totalPriceEl = document.getElementById('totalPrice');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const emptyMessage = document.getElementById('emptyMessage');

    // Fetch cart dari database
    async function fetchCart() {
      try {
        const res = await fetch(`${API_BASE}/get_cart.php`, {
          method: 'GET',
          credentials: 'include' // Kirim session cookie
        });
        const data = await res.json();

        if (data.cart && data.cart.length > 0) {
          renderCart(data.cart);
        } else {
          showEmptyCart();
        }
      } catch (err) {
        console.error('Gagal fetch cart:', err);
        showEmptyCart('Gagal memuat keranjang. Pastikan Anda sudah login.');
      }
    }

    function renderCart(cart) {
      cartItemsDiv.innerHTML = '';
      let total = 0;

      emptyMessage.style.display = 'none';
      checkoutBtn.style.display = 'inline-block';

      cart.forEach(item => {
        const subtotal = item.price * item.qty;
        total += subtotal;

        const itemEl = document.createElement('div');
        itemEl.className = 'cart-item d-flex justify-content-between align-items-center';
        itemEl.innerHTML = `
          <div>
            <h6 class="mb-1">${item.product_name}</h6>
            <small class="text-muted">${item.qty} x Rp${parseFloat(item.price).toLocaleString('id-ID')}</small>
          </div>
          <div class="text-end">
            <strong>Rp${subtotal.toLocaleString('id-ID')}</strong><br>
            <button class="btn btn-delete btn-sm mt-1" onclick="removeItem(${item.product_id})">
              HAPUS
            </button>
          </div>
        `;
        cartItemsDiv.appendChild(itemEl);
      });

      totalPriceEl.textContent = `Rp${total.toLocaleString('id-ID')}`;
      updateCartBadge(cart);
    }

    function showEmptyCart(msg = 'Keranjang belanja kosong.') {
      emptyMessage.textContent = msg;
      emptyMessage.style.display = 'block';
      checkoutBtn.style.display = 'none';
      totalPriceEl.textContent = 'Rp0';
    }

    // Hapus item dari cart
    async function removeItem(productId) {
      if (!confirm('Hapus item ini dari keranjang?')) return;

      try {
        const res = await fetch(`${API_BASE}/remove_from_cart.php`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: productId }),
          credentials: 'include'
        });
        const data = await res.json();

        if (data.success) {
          fetchCart(); // Refresh
        } else {
          alert('Gagal hapus: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Error:', err);
        alert('Terjadi kesalahan saat menghapus item.');
      }
    }

    // Update badge di navbar
    function updateCartBadge(cart) {
      const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
      const badge = document.getElementById('cartCount');
      if (badge) {
        badge.textContent = totalItems;
        badge.style.display = totalItems > 0 ? 'inline' : 'none';
      }
    }

    // Cek login saat load
    async function checkLogin() {
      try {
        const res = await fetch(`${API_BASE}/get_cart.php`, { credentials: 'include' });
        if (!res.ok) throw new Error('Not logged in');
      } catch {
        showEmptyCart('Silakan login terlebih dahulu.');
        setTimeout(() => window.location.href = 'loginuser.html', 2000);
      }
    }

    // Jalankan saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
      checkLogin();
      fetchCart();
    });
  </script>
</body>
</html>